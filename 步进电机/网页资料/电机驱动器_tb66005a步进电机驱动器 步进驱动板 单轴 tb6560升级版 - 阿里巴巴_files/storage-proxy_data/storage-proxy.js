define(["lofty/lang/class","lofty/lang/base","jquery","lofty/util/messenger/2.0/messenger","lofty/util/json/1.0/json","lofty/util/storage/2.0/storage"],function(e,t,s,n,a,r){"use strict";var i=e(t,{init:function(e){t.prototype.init.call(this,e||{});var s=this;this.storage=new r,this.storage.ready(function(){s.createMessenger(),s.sendMessage("proxyReady")})},getQuery:function(e){var t=e.lastIndexOf("?");return 0>t?"":(e=e.substring(t+1,e.length),t=e.indexOf("#"),t>=0&&(e=e.substring(0,t)),e)},getSimpleParams:function(e,t){return this.getParams(e,t,!0)},getParams:function(e,t,s){for(var n,a=e||window.location.href,r={},i=this.getQuery(a).split("&"),o=0;o<i.length;o++)try{if(i[o].indexOf("=")<=0)continue;n=i[o].split("=");var g,c;t&&"raw"===t.toLowerCase()?(g=n[0],c=n[1]):(g=decodeURIComponent(n[0]),c=decodeURIComponent(n[1])),s?r[g]=c:r[g]?r[g].push(c):r[g]=[c]}catch(l){}return r},handleProxyReady:function(){this.sendMessage("proxyReady")},callbackMessage:function(e,t){var s=this,n=s.getConfigs(t,{});switch(e){case"proxyReady":s._init_||(s.handleProxyReady(),s._init_=!0);break;case"setItem":case"getItem":case"removeItem":case"getJson":case"setJson":case"clear":case"getLength":case"key":s.storage[e]&&(n.result=s.storage[e].apply(s.storage,n.data||[]),s.sendMessage(e,n))}},getConfigs:function(e,t){var n=t;try{n=s.parseJSON(e)}catch(a){n=t}return n},sendMessage:function(e,t){t=t||"","string"!=typeof t&&(t=a.stringify(t)),this.messenger.send(e+"|"+t)},createMessenger:function(){var e=this,t=this.getSimpleParams().messageId,s=new n(t,t);s.listen(function(t){var s=t.indexOf("|"),n=t.substring(0,s),a=t.substring(s+1,t.length);e.callbackMessage(n,a)}),s.addTarget(window.parent,t),this.messenger=s}});s(function(){new i})});;